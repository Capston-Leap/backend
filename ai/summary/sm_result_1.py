from sm_load import load_kobart_model

import logging
logging.getLogger("transformers").setLevel(logging.ERROR)

import torch
import sys # ì¶”ê°€

tokenizer, model = load_kobart_model('ai/summary/kobart_summary')

# === ì¶”ê°€ === #
if len(sys.argv) < 2:
    print("ì…ë ¥ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
    sys.exit(1)
# === ì¶”ê°€ ë === #
# === ìˆ˜ì • === #
# input_text =  """
# ì˜¤ëŠ˜ì€ ì •ë§ ë§‘ê³  ë”°ëœ»í•œ ë‚ ì´ì—ˆë‹¤. ì•„ì¹¨ì— ì¼ì–´ë‚˜ìë§ˆì ì°½ë¬¸ì„ ì—´ì–´ë³´ë‹ˆ ë§‘ì€ í•˜ëŠ˜ê³¼ ë”°ëœ»í•œ í–‡ì‚´ì´ ë‚˜ë¥¼ ë°˜ê²¨ì£¼ì—ˆë‹¤. ë‚ ì”¨ê°€ ì´ë ‡ê²Œ ì¢‹ìœ¼ë‹ˆ ê¸°ë¶„ë„ ì ˆë¡œ ì¢‹ì•„ì¡Œë‹¤. ìš”ì¦˜ ë°”ìœ ì¼ìƒ ì†ì—ì„œ ì ì‹œë‚˜ë§ˆ ë§ˆìŒì˜ ì—¬ìœ ë¥¼ ì°¾ì„ ìˆ˜ ìˆëŠ” ë‚ ì´ì—ˆë‹¤.
#
# ì¼ì° ì¼ì–´ë‚œ ë•ë¶„ì— ì•„ì¹¨ ì‚°ì±…ì„ ë‹¤ë…€ì˜¤ê¸°ë¡œ ë§ˆìŒë¨¹ì—ˆë‹¤. ê³µì›ì— ë„ì°©í–ˆì„ ë•Œ, ê³µê¸°ë§ˆì € ìƒì¾Œí•˜ê²Œ ëŠê»´ì¡Œë‹¤. ë„ë¡œ ì£¼ë³€ì—ëŠ” ë´„ê½ƒë“¤ì´ ë§Œê°œí•´ ìˆì—ˆê³ , íŠ¹íˆ ë²šê½ƒì´ ì˜ˆì˜ê²Œ í”¼ì–´ ìˆì—ˆë‹¤. ë²šê½ƒì˜ í•˜ì–€ ê½ƒìë“¤ì´ ë°”ëŒì— ë‚ ë¦¬ë©° ë•…ì— ë–¨ì–´ì§€ëŠ” ëª¨ìŠµì€ ì •ë§ ì•„ë¦„ë‹¤ì› ë‹¤. ì ì‹œ ë²¤ì¹˜ì— ì•‰ì•„ ë²šê½ƒì„ ë³´ë©° ë§ˆìŒì˜ í‰í™”ë¥¼ ëŠë‚„ ìˆ˜ ìˆì—ˆë‹¤. ë´„ì˜ ê¸°ìš´ì´ ê°€ë“í•œ ìˆœê°„ì´ì—ˆë‹¤.
#
# ì‚°ì±…ì„ ë§ˆì¹œ í›„, ì˜¤ëœë§Œì— ë§Œë‚˜ëŠ” ì¹œêµ¬ì™€ ì ì‹¬ì„ í•¨ê»˜ ë¨¹ê¸°ë¡œ í–ˆë‹¤. ìš°ë¦¬ëŠ” ì¢‹ì•„í•˜ëŠ” ìŒì‹ì ì— ê°€ì„œ ë§›ìˆëŠ” ìŒì‹ì„ ë¨¹ìœ¼ë©° ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ëƒˆë‹¤. ì˜¤ëœë§Œì— ë§Œë‚˜ëŠ” ì¹œêµ¬ë¼ ê·¸ëŸ°ì§€, ìš°ë¦¬ëŠ” ì„œë¡œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ëŠ” ë™ì•ˆ ì‹œê°„ì„ ìŠê³  ì›ƒìŒì´ ëŠì´ì§€ ì•Šì•˜ë‹¤. ì¹œêµ¬ì˜ ê·¼í™©ê³¼ ë‚´ê°€ ìµœê·¼ì— ê²ªì€ ì¼ë“¤ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ë©°, ìš°ë¦¬ëŠ” ê·¸ë™ì•ˆ ìŒ“ì˜€ë˜ ì´ì•¼ê¸°ë“¤ì„ í’€ì–´ë†“ì„ ìˆ˜ ìˆì—ˆë‹¤. ê·¸ì™€ì˜ ëŒ€í™”ëŠ” í•­ìƒ ì¦ê²ê³  ìœ ìµí•˜ë‹¤.
#
# ì ì‹¬ì„ ë§ˆì¹œ í›„ì—ëŠ” ë„ì„œê´€ìœ¼ë¡œ ê°€ì„œ ê³µë¶€ë¥¼ í–ˆë‹¤. ì˜¤ëœë§Œì— ì§‘ì¤‘í•´ì„œ ê³µë¶€í•˜ë‹ˆ ë¨¸ë¦¬ê°€ ë§‘ì•„ì§€ëŠ” ëŠë‚Œì´ì—ˆë‹¤. ë„ì„œê´€ì—ì„œ ì±…ì„ ì½ê±°ë‚˜ í•„ê¸°ë¥¼ í•˜ë©° ì‹œê°„ì„ ë³´ëƒˆê³ , ê³µë¶€ê°€ ëë‚  ì¦ˆìŒì—ëŠ” ì–´ëŠìƒˆ ì˜¤í›„ê°€ ë‹¤ ì§€ë‚˜ê°€ ìˆì—ˆë‹¤. ê·¸ë ‡ê²Œ ì ì‹œë‚˜ë§ˆ í•™ë¬¸ì— ëª°ë‘í•  ìˆ˜ ìˆëŠ” ì‹œê°„ë„ ì •ë§ ì†Œì¤‘í•˜ê²Œ ëŠê»´ì¡Œë‹¤.
#
# ì €ë…ì´ ë˜ì, ê°€ì¡±ê³¼ í•¨ê»˜ ë§›ìˆëŠ” ì‹ì‚¬ë¥¼ í–ˆë‹¤. ì˜¤ëŠ˜ì€ ëª¨ë‘ê°€ ëª¨ì—¬ì„œ í•¨ê»˜ ìŒì‹ì„ ë‚˜ëˆ„ë©° ëŒ€í™”ë¥¼ ë‚˜ëˆ„ëŠ” ì‹œê°„ì„ ê°€ì¡Œë‹¤. ê°€ì¡±ë“¤ê³¼ í•¨ê»˜ í•˜ëŠ” ì €ë…ì€ ì–¸ì œë‚˜ ë”°ëœ»í•˜ê³  í‰í™”ë¡­ë‹¤. ì„œë¡œì˜ ì¼ìƒ ì´ì•¼ê¸°ë¥¼ ë“¤ìœ¼ë©°, ì¢‹ì€ ì‹œê°„ì„ ë³´ë‚¼ ìˆ˜ ìˆì—ˆë‹¤.
#
# ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì •ë§ í‰í™”ë¡­ê³  ì¡°ìš©í•œ í•˜ë£¨ì˜€ë‹¤. ë‚ ì”¨ë„ ì¢‹ê³ , ì¹œêµ¬ì™€ì˜ ë§Œë‚¨, ê°€ì¡±ê³¼ì˜ ì‹ì‚¬ ë“± ì‘ì€ ìˆœê°„ë“¤ì´ ëª¨ë‘ ì†Œì¤‘í•˜ê³  í–‰ë³µí•˜ê²Œ ëŠê»´ì¡Œë‹¤. ë°”ìœ ì¼ìƒ ì†ì—ì„œë„ ì´ëŸ° ì—¬ìœ ë¡œìš´ ì‹œê°„ì„ ë³´ë‚¼ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ ì–¼ë§ˆë‚˜ í° ì¶•ë³µì¸ì§€ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ê¹¨ë‹«ê²Œ ë˜ëŠ” í•˜ë£¨ì˜€ë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì •ë§ ê°ì‚¬í•˜ê³ , í–‰ë³µí•œ ì‹œê°„ì´ì—ˆë‹¤.
# """

input_text = sys.argv[1]
# === ìˆ˜ì • ë === #

if len(input_text) >= 100:
    # 100ì ì´ìƒì¼ ê²½ìš° ìš”ì•½ ìˆ˜í–‰
    text = input_text.replace('\n', ' ')

    raw_input_ids = tokenizer.encode(text)
    input_ids = [tokenizer.bos_token_id] + raw_input_ids + [tokenizer.eos_token_id]
    input_ids = torch.tensor([input_ids])

    summary_text_ids = model.generate(
        input_ids=input_ids,
        bos_token_id=model.config.bos_token_id,
        eos_token_id=model.config.eos_token_id,
        length_penalty=0.6,  # ê¸¸ì´ì— ëŒ€í•œ penalty ê°’. 1ë³´ë‹¤ ì‘ì€ ê²½ìš° ë” ì§§ì€ ë¬¸ì¥ì„ ìƒì„±í•˜ë„ë¡ ìœ ë„
        max_length=64,  # ìš”ì•½ë¬¸ì˜ ìµœëŒ€ ê¸¸ì´ ì„¤ì •
        min_length=4,  # ìš”ì•½ë¬¸ì˜ ìµœì†Œ ê¸¸ì´ ì„¤ì •
        num_beams=5,  # Beam search íƒìƒ‰ í­: ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ 5ê°œì˜ í›„ë³´ë¥¼ ë™ì‹œì— íƒìƒ‰
        num_return_sequences=1,  # í•˜ë‚˜ë§Œ ì¶œë ¥!
        repetition_penalty=3.0,  # ë°˜ë³µ ì–µì œ
        no_repeat_ngram_size=3,  # N-gram ë°˜ë³µ ì–µì œ
        early_stopping=True,  # ì¡°ê±´ ì¶©ì¡± ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
    )

    summary_text = tokenizer.decode(summary_text_ids[0], skip_special_tokens=True)

    print("="*50)
    print("ğŸ“ ì›ë¬¸:")
    print(input_text)
    print("\nğŸ“Œ ìš”ì•½:")
    print(summary_text)
    print("="*50)
else:
    # 100ì ë¯¸ë§Œì´ë©´ ì›ë¬¸ ê·¸ëŒ€ë¡œ ì¶œë ¥
    print("="*50)
    print("ğŸ“Œ ìš”ì•½:")
    print(input_text)
    print("="*50)